<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pedidos por Reparto ‚Äî Simple</title>
  <style>
    :root{--bg:#0b0c10;--card:#111318;--muted:#8b929e;--text:#e9eef5;--brand:#ff3b3b}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    header{padding:18px 22px;border-bottom:1px solid #1d2026;display:flex;gap:14px;align-items:center}
    header h1{font-size:18px;margin:0;font-weight:700}
    main{max-width:1200px;margin:22px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #1d2026;border-radius:14px;padding:16px}
    .grid{display:grid;gap:12px}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2f37;background:#0f1116;color:var(--text);outline:none}
    button{background:var(--brand);border-color:transparent;font-weight:700;cursor:pointer}
    button.secondary{background:#0f1116;border:1px solid #2a2f37}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .table-wrap{overflow:auto;border:1px solid #1d2026;border-radius:12px}
    table{border-collapse:collapse;width:100%;min-width:880px}
    th,td{padding:10px 12px;border-bottom:1px solid #1d2026;font-size:14px;text-align:left;white-space:nowrap}
    th{position:sticky;top:0;background:#0f1116;z-index:1}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a2f37;color:#cbd5e1}
    .ok{color:#c7facc;border-color:#16361f;background:#0f1b12}
    .warn{color:#ffe9bf;border-color:#3b2d13;background:#17120a}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header><h1>Pedidos por Reparto</h1><span class="muted">Chess ERP</span></header>
  <main>
    <div class="card">
      <div class="grid cols-4">
        <div><label>Fecha entrega ‚Äî desde</label><input type="date" id="fechaDesde"></div>
        <div><label>Fecha entrega ‚Äî hasta</label><input type="date" id="fechaHasta"></div>
        <div>
          <label>Estado de factura</label>
          <select id="facturado">
            <option value="all">Todos</option>
            <option value="true">Facturado</option>
            <option value="false">No facturado</option>
          </select>
        </div>
        <div>
          <label>Reparto</label>
          <select id="reparto"><option value="">(cargar repartos‚Ä¶)</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnCargarRepartos" class="secondary">üîÅ Cargar repartos</button>
        <button id="btnListar">üì¶ Listar pedidos</button>
        <button id="btnCSV" class="secondary" disabled>‚¨áÔ∏è Exportar CSV</button>
      </div>
      <div id="msg" class="muted" style="margin-top:8px;"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="table-wrap">
        <table id="tabla">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    const $ = (id)=>document.getElementById(id);
    const fmtDate = (d)=> d instanceof Date ? d.toISOString().slice(0,10) : d;

    function init() {
      const hoy = new Date();
      const desde = new Date(hoy); desde.setDate(hoy.getDate()-7);
      $("fechaDesde").value = fmtDate(desde);
      $("fechaHasta").value = fmtDate(hoy);
      $("facturado").value = "all";
      $("btnCSV").disabled = true;
      setMsg("Eleg√≠ rango y carg√° repartos.");
    }
    function setMsg(t){ $("msg").textContent = t || ""; }

    function readFilters(includeReparto=true){
      const p = new URLSearchParams();
      p.set("fechaDesde", $("fechaDesde").value);
      p.set("fechaHasta", $("fechaHasta").value);
      const f = $("facturado").value;
      if (f !== "all") p.set("facturado", f);
      if (includeReparto && $("reparto").value) p.set("idReparto", $("reparto").value);
      return p.toString();
    }

    async function cargarRepartos(){
      setMsg("Cargando repartos‚Ä¶");
      $("reparto").innerHTML = `<option value="">(cargando‚Ä¶)</option>`;
      try{
        const r = await fetch(`/api/pedidos-repartos?${readFilters(false)}`);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const lista = await r.json();
        lista.sort((a,b)=> (a.dsReparto||"").localeCompare(b.dsReparto||""));
        $("reparto").innerHTML = `<option value="">(todos)</option>` + lista.map(x=>(
          `<option value="${String(x.idReparto)}">${String(x.dsReparto||x.idReparto)}</option>`
        )).join("");
        setMsg(`Repartos cargados: ${lista.length}`);
      }catch(e){
        console.error(e);
        $("reparto").innerHTML = `<option value="">(error)</option>`;
        setMsg("No se pudieron cargar repartos.");
      }
    }

    async function listarPedidos(){
      setMsg("Buscando pedidos‚Ä¶");
      try{
        const r = await fetch(`/api/pedidos?${readFilters(true)}`);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        renderTable(data);
        setMsg("Listo ‚úÖ");
      }catch(e){
        console.error(e);
        renderTable([]);
        setMsg("No se pudieron obtener pedidos.");
      }
    }

    function renderTable(items){
      const thead = $("thead"), tbody = $("tbody");
      thead.innerHTML=""; tbody.innerHTML=""; $("btnCSV").disabled = true;
      if(!Array.isArray(items) || items.length===0) return;

      const preferred = [
        "idReparto","dsReparto","fechaEntrega","fecha","idPedido","numero","nroPedido",
        "cliente.idCliente","cliente.nombre","facturado","importeTotal"
      ];
      const flat = items.map(flatten);
      const cols = Array.from(new Set([
        ...preferred.filter(c => flat.some(r => c in r)),
        ...Object.keys(flat[0])
      ]));
      thead.innerHTML = `<tr>${cols.map(c=>`<th>${escapeHtml(c)}</th>`).join("")}</tr>`;
      tbody.innerHTML = flat.map(r=> `<tr>${
        cols.map(c=>{
          let v = r[c];
          if (c.toLowerCase().includes("fecha") && typeof v === "string") v = v.slice(0,10);
          if (c.toLowerCase()==="facturado") v = badgeBool(v);
          return `<td>${renderVal(v)}</td>`;
        }).join("")
      }</tr>`).join("");

      window.__lastCols = cols;
      window.__lastRows = flat;
      $("btnCSV").disabled = false;
    }

    function renderVal(v){
      if (v === null || v === undefined || v === "") return `<span class="muted">‚Äî</span>`;
      if (typeof v === "boolean") return badgeBool(v);
      return escapeHtml(String(v));
    }
    function badgeBool(v){
      const val = (v===true || v==="true" || v===1 || v==="1");
      return `<span class="badge ${val?'ok':'warn'}">${val?'Facturado':'No facturado'}</span>`;
    }
    function flatten(obj, prefix="", out={}){
      for (const [k,v] of Object.entries(obj||{})){
        const key = prefix? `${prefix}.${k}` : k;
        if (v && typeof v === "object" && !Array.isArray(v)) flatten(v, key, out);
        else out[key] = v;
      }
      return out;
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function exportCSV(){
      const cols = window.__lastCols || [];
      const rows = window.__lastRows || [];
      if (!cols.length || !rows.length) return;
      const header = cols.join(",");
      const body = rows.map(r=> cols.map(c=>{
        const s = r[c]==null ? "" : String(r[c]).replace(/"/g,'""');
        return `"${s}"`;
      }).join(",")).join("\n");
      const blob = new Blob([header+"\n"+body], {type:"text/csv;charset=utf-8;"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `pedidos_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    }

    $("btnCargarRepartos").addEventListener("click", cargarRepartos);
    $("btnListar").addEventListener("click", listarPedidos);
    $("btnCSV").addEventListener("click", exportCSV);
    ["fechaDesde","fechaHasta","facturado"].forEach(id=>{
      $(id).addEventListener("change", ()=>{ $("reparto").innerHTML=`<option value="">(cargar repartos‚Ä¶)</option>`; });
    });
    init();
  </script>
</body>
</html>
