<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pedidos por Reparto ‚Äî Simple</title>
  <style>
    :root{--bg:#0b0c10;--card:#111318;--muted:#8b929e;--text:#e9eef5;--brand:#ff3b3b;--ok:#16a34a;--warn:#f59e0b;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    header{padding:18px 22px;border-bottom:1px solid #1d2026;display:flex;gap:14px;align-items:center}
    header h1{font-size:18px;margin:0;font-weight:700}
    header .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    main{max-width:1200px;margin:22px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #1d2026;border-radius:14px;padding:16px}
    .grid{display:grid;gap:12px}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2f37;background:#0f1116;color:var(--text);outline:none}
    button{background:var(--brand);border-color:transparent;font-weight:700;cursor:pointer}
    button.secondary{background:#0f1116;border:1px solid #2a2f37}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .table-wrap{overflow:auto;border:1px solid #1d2026;border-radius:12px}
    table{border-collapse:collapse;width:100%;min-width:880px}
    th,td{padding:10px 12px;border-bottom:1px solid #1d2026;font-size:14px;text-align:left;white-space:nowrap}
    th{position:sticky;top:0;background:#0f1116;z-index:1}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a2f37;color:var(--muted)}
    .badge.ok{color:#c7facc;border-color:#16361f;background:#0f1b12}
    .badge.warn{color:#ffe9bf;border-color:#3b2d13;background:#17120a}
    .muted{color:var(--muted)}
    .spacer{height:10px}
    footer{opacity:.7;font-size:12px;text-align:center;padding:14px}
  </style>
</head>
<body>
  <header>
    <div class="dot"></div>
    <h1>Pedidos por Reparto</h1>
    <span class="muted">Chess ERP ¬∑ /Ventas/pedidos</span>
  </header>

  <main>
    <div class="card">
      <div class="grid cols-4">
        <div>
          <label>Fecha entrega ‚Äî desde</label>
          <input type="date" id="fechaDesde">
        </div>
        <div>
          <label>Fecha entrega ‚Äî hasta</label>
          <input type="date" id="fechaHasta">
        </div>
        <div>
          <label>Estado de factura</label>
          <select id="facturado">
            <option value="all">Todos</option>
            <option value="true">Facturado</option>
            <option value="false">No facturado</option>
          </select>
        </div>
        <div>
          <label>Reparto</label>
          <select id="reparto">
            <option value="">(cargar repartos‚Ä¶)</option>
          </select>
        </div>
      </div>

      <div class="spacer"></div>
      <div class="row">
        <button id="btnCargarRepartos" class="secondary">üîÅ Cargar repartos</button>
        <button id="btnListar">üì¶ Listar pedidos</button>
        <button id="btnCSV" class="secondary" disabled>‚¨áÔ∏è Exportar CSV</button>
      </div>
      <div id="msg" class="muted" style="margin-top:8px;"></div>
    </div>

    <div class="spacer"></div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <div><strong>Resultado</strong> <span id="count" class="badge">0 √≠tems</span></div>
        <div class="muted">Tip: el combo de Repartos se arma en base a los pedidos del rango seleccionado.</div>
      </div>
      <div class="spacer"></div>

      <div class="table-wrap">
        <table id="tabla">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <footer>Simple Distribuciones ‚Äî hecho con ‚ù§Ô∏è</footer>

  <script>
    const $ = (id)=>document.getElementById(id);
    const fmtDate = (d)=> d instanceof Date ? d.toISOString().slice(0,10) : d;

    function setDefaults() {
      const hoy = new Date();
      const desde = new Date(hoy); desde.setDate(hoy.getDate()-7);
      $("fechaDesde").value = fmtDate(desde);
      $("fechaHasta").value = fmtDate(hoy);
      $("facturado").value = "all";
      $("reparto").innerHTML = `<option value="">(cargar repartos‚Ä¶)</option>`;
      $("btnCSV").disabled = true;
      setMsg("Listo. Eleg√≠ rango y carg√° repartos.");
    }

    function setMsg(t){ $("msg").textContent = t || ""; }
    function setCount(n){ $("count").textContent = `${n} √≠tems`; }

    function readFilters(includeReparto=true){
      const fDesde = $("fechaDesde").value;
      const fHasta = $("fechaHasta").value;
      const fact = $("facturado").value; // "all" | "true" | "false"
      const reparto = includeReparto ? $("reparto").value : "";
      const params = new URLSearchParams({ fechaDesde: fDesde, fechaHasta: fHasta });
      if (fact !== "all") params.set("facturado", fact);
      if (includeReparto && reparto) params.set("idReparto", reparto);
      return params.toString();
    }

    async function cargarRepartos(){
      setMsg("Cargando repartos‚Ä¶");
      $("reparto").innerHTML = `<option value="">(cargando‚Ä¶)</option>`;
      try{
        const qs = readFilters(false);
        const r = await fetch(`/api/pedidos-repartos?${qs}`);
        if(!r.ok){ throw new Error(`HTTP ${r.status}`); }
        const lista = await r.json(); // [{idReparto, dsReparto}]
        if(!Array.isArray(lista)) throw new Error("Respuesta inesperada");
        lista.sort((a,b)=> (a.dsReparto||"").localeCompare(b.dsReparto||""));
        let html = `<option value="">(todos)</option>`;
        for(const it of lista){
          const id = it.idReparto ?? "";
          const ds = it.dsReparto ?? "";
          html += `<option value="${String(id)}">${String(ds || id)}</option>`;
        }
        $("reparto").innerHTML = html || `<option value="">(sin datos)</option>`;
        setMsg(`Repartos cargados (${lista.length}). Eleg√≠ uno y list√° pedidos.`);
      }catch(err){
        console.error(err);
        $("reparto").innerHTML = `<option value="">(error cargando)</option>`;
        setMsg("No se pudieron cargar repartos. Revis√° fechas / estado / servidor.");
      }
    }

    function renderTable(items){
      const thead = $("thead"), tbody = $("tbody");
      thead.innerHTML = ""; tbody.innerHTML = ""; setCount(0);
      if(!Array.isArray(items) || items.length===0){ $("btnCSV").disabled = true; return; }

      // Definimos columnas ‚Äúamistosas‚Äù si aparecen
      const preferred = [
        "idReparto","dsReparto",
        "fechaEntrega","fecha","fechaComprobante",
        "idPedido","numero","nroPedido",
        "cliente.idCliente","cliente.nombre","cliente.razonSocial",
        "facturado","estado","importeTotal","importe"
      ];
      const cols = Array.from(new Set([
        ...preferred.filter(c=> items.some(it => hasKey(it,c))),
        ...Object.keys(flatten(items[0]))
      ]));

      // Header
      thead.innerHTML = `<tr>${cols.map(c=>`<th>${escapeHtml(c)}</th>`).join("")}</tr>`;

      // Rows
      const rows = items.map(it=>{
        const flat = flatten(it);
        return `<tr>${cols.map(c=>{
          let v = flat[c];
          if (c.toLowerCase().includes("fecha") && typeof v === "string") v = v.slice(0,10);
          if (c.toLowerCase()==="facturado") v = badgeBool(v);
          return `<td>${renderVal(v)}</td>`;
        }).join("")}</tr>`;
      }).join("");

      tbody.innerHTML = rows;
      setCount(items.length);
      $("btnCSV").disabled = false;
      // store last for CSV
      window.__lastItems = items.map(flatten);
      window.__lastCols = cols;
    }

    function renderVal(v){
      if (v === null || v === undefined || v === "") return `<span class="muted">‚Äî</span>`;
      if (typeof v === "boolean") return badgeBool(v);
      return escapeHtml(String(v));
    }

    function badgeBool(v){
      const val = (v===true || v==="true" || v===1 || v==="1");
      return `<span class="badge ${val?'ok':'warn'}">${val?'Facturado':'No facturado'}</span>`;
    }

    function hasKey(obj, dotted){
      const parts = dotted.split(".");
      let cur = obj;
      for(const p of parts){
        if(!cur || typeof cur!=="object" || !(p in cur)) return false;
        cur = cur[p];
      }
      return true;
    }

    function flatten(obj, prefix="", out={}){
      for(const [k,v] of Object.entries(obj||{})){
        const key = prefix? `${prefix}.${k}` : k;
        if (v && typeof v === "object" && !Array.isArray(v)){
          flatten(v, key, out);
        } else {
          out[key] = v;
        }
      }
      return out;
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    async function listarPedidos(){
      setMsg("Buscando pedidos‚Ä¶");
      try{
        const qs = readFilters(true);
        const r = await fetch(`/api/pedidos?${qs}`);
        if(!r.ok){ throw new Error(`HTTP ${r.status}`); }
        const data = await r.json(); // puede ser {data:[...]} o [...]
        const items = Array.isArray(data) ? data : (Array.isArray(data?.data)? data.data : (Array.isArray(data?.items)? data.items : []));
        renderTable(items);
        setMsg("Listo ‚úÖ");
      }catch(err){
        console.error(err);
        renderTable([]);
        setMsg("No se pudieron obtener pedidos. Prob√° cambiando filtros.");
      }
    }

    function exportCSV(){
      const cols = window.__lastCols || [];
      const rows = window.__lastItems || [];
      if (!cols.length || !rows.length) return;
      const header = cols.join(",");
      const body = rows.map(r=> cols.map(c=>{
        const val = r[c];
        const s = (val===undefined || val===null) ? "" : String(val).replace(/"/g,'""');
        return `"${s}"`;
      }).join(",")).join("\n");
      const blob = new Blob([header+"\n"+body], {type:"text/csv;charset=utf-8;"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `pedidos_${fmtDate(new Date())}.csv`;
      a.click();
    }

    // Events
    $("btnCargarRepartos").addEventListener("click", cargarRepartos);
    $("btnListar").addEventListener("click", listarPedidos);
    $("btnCSV").addEventListener("click", exportCSV);
    ["fechaDesde","fechaHasta","facturado"].forEach(id=>{
      $(id).addEventListener("change", ()=>{ $("reparto").innerHTML=`<option value="">(cargar repartos‚Ä¶)</option>`; });
    });

    // Init
    setDefaults();
  </script>
</body>
</html>
